#!/bin/bash

# Deploy an arbitrary number of strategies
# TODO Install everything to home directory


freqtrade_bots="%h/freqtrade-bots"  # TODO Refactor install location
freqtrade="%h/freqtrade"  # TODO Refactor install location
systemd_dir=$HOME/.config/systemd/user


function snake_case() {
  echo $1 | sed -r 's/([A-Z])/_\L\1/g' | sed 's/^_//'
}


function with_permission () {
  read -p "$2" -n 1 -r
  echo    # (optional) move to a new line
  if [[ $REPLY =~ ^[Yy]$ ]]
  then
    $1
  fi
}


function stop_bots () {
  for bot in $@
  do
    service="$bot.service"
    systemctl --user stop $service
    echo "Stopped Systemd service $service"
  done
}


function status_bots () {
  for bot in $@
  do
    service="$bot.service"
    systemctl --user status $service
    echo
  done
}


mkdir -p $systemd_dir


for bot in $@
do
  # Maps CamelCase to snake_case
  f="$systemd_dir/$(snake_case $strategy).service"
  rm $f
  touch $f
  echo "[Unit]"                                    >> $f
  echo "Description=Freqtrade $bot daemon"         >> $f
  echo "After=network.target"                      >> $f
  echo ""                                          >> $f
  echo "[Service]"                                 >> $f
  echo "WorkingDirectory=$freqtrade_bots/$bot"     >> $f
  echo "ExecStart=bash $freqtrade_bots/$bot/run"   >> $f
  echo "Restart=on-failure"                        >> $f
  echo ""                                          >> $f
  echo "[Install]"                                 >> $f
  echo "WantedBy=default.target"                   >> $f
done


systemctl --user daemon-reload


for bot in $@
do
  systemctl --user start "$(snake_case $bot).service"
  echo "Deployed a Freqtrade bot with strategy $bot"
done


with_permission \
  "sudo loginctl enable-linger $USER" \
  "Enable lingering mode for user $USER?"
with_permission \
  "sudo systemctl restart systemd-journald.service" \
  "Restart Journald service?"
