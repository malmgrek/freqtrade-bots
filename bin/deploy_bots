#!/bin/bash

# Deploy an arbitrary number of strategies


work="%h/src/freqtrade-strategies"
freqtrade="%h/src/freqtrade"
freqtrade_wrapper="$work/bin/freqtrade_wrapper"
activate="$freqtrade/.env/bin/activate"
jobdir=$HOME/.config/systemd/user


function snake_case() {
  echo $1 | sed -r 's/([A-Z])/_\L\1/g' | sed 's/^_//'
}


function with_permission () {
  read -p "$2" -n 1 -r
  echo    # (optional) move to a new line
  if [[ $REPLY =~ ^[Yy]$ ]]
  then
    $1
  fi
}


mkdir -p $jobdir


for strategy in $@
do

  # Maps CamelCase to snake_case
  job="$jobdir/$(snake_case $strategy).service"
  rm $job
  touch $job
  echo "[Unit]"                                                         >> $job
  echo "Description=Freqtrade $strategy daemon"                         >> $job
  echo "After=network.target"                                           >> $job
  echo ""                                                               >> $job
  echo "[Service]"                                                      >> $job
  echo "WorkingDirectory=$work"                                         >> $job
  echo "ExecStart=bash $freqtrade_wrapper -v $activate -s $strategy -t" >> $job
  echo "Restart=on-failure"                                             >> $job
  echo ""                                                               >> $job
  echo "[Install]"                                                      >> $job
  echo "WantedBy=default.target"                                        >> $job

done


systemctl --user daemon-reload


for strategy in $@
do

  systemctl --user start "$(snake_case $strategy).service"
  echo "Deployed a Freqtrade bot with strategy $strategy"

done


with_permission "sudo loginctl enable-linger $USER" "Enable lingering mode for user $USER?"
with_permission "sudo systemctl restart systemd-journald.service" "Restart Journald service?"
